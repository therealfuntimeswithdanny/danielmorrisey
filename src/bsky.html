<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bluesky Feed Viewer | madebydanny.uk</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Simple scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b;
        }
        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 antialiased">

    <div class="container mx-auto max-w-2xl p-4 sm:p-6">
        
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-sky-400">Bluesky Feed</h1>
            <p class="text-slate-400 mt-2">
                Showing recent posts from 
                <a href="https://bsky.app/profile/madebydanny.uk" target="_blank" rel="noopener noreferrer" class="font-semibold text-sky-500 hover:underline">
                    @madebydanny.uk
                </a>
            </p>
        </header>

        <!-- Loading Spinner -->
        <div id="loading" class="text-center py-10">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-sky-400"></div>
            <p class="mt-2 text-slate-400">Fetching posts...</p>
        </div>

        <!-- Error Message Container -->
        <div id="error-message" class="hidden bg-red-900/50 border border-red-700 text-red-300 px-4 py-3 rounded-lg text-center">
            <!-- Error content will be inserted here -->
        </div>

        <!-- Posts Container -->
        <main id="posts-container" class="space-y-4">
            <!-- Posts will be dynamically inserted here -->
        </main>
        
        <!-- Footer -->
        <footer class="text-center mt-12 text-slate-500 text-sm">
            <p>Built with Tailwind CSS & the Bluesky API.</p>
        </footer>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const postsContainer = document.getElementById('posts-container');
            const loadingIndicator = document.getElementById('loading');
            const errorMessageContainer = document.getElementById('error-message');
            
            // NOTE: The Bluesky API is public but can be strict.
            // If this direct URL fails due to CORS, a simple proxy server might be needed.
            const apiUrl = 'https://api.bsky.app/xrpc/app.bsky.feed.searchPosts?q=from%3Amadebydanny.uk';

            // Function to format the date string into something more readable
            function formatDate(isoString) {
                if (!isoString) return 'Unknown date';
                const date = new Date(isoString);
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit'
                });
            }

            // Function to linkify text (finds URLs and makes them clickable)
            function linkifyText(text) {
                const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
                return text.replace(urlRegex, url => `<a href="${url}" target="_blank" rel="noopener noreferrer" class="text-sky-400 hover:underline break-all">${url}</a>`);
            }

            // Function to render different types of embeds (images, quotes)
            function renderEmbed(embed) {
                if (!embed) return '';

                let embedHtml = '';

                // Case 1: Just images
                if (embed.$type === 'app.bsky.embed.images' && embed.images) {
                    embedHtml += '<div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-2">';
                    embed.images.forEach(image => {
                        embedHtml += `
                            <a href="${image.fullsize}" target="_blank" rel="noopener noreferrer">
                                <img src="${image.thumb}" alt="${image.alt || 'Embedded image'}" class="rounded-md w-full h-auto object-cover border border-slate-600 hover:opacity-80 transition-opacity">
                            </a>
                        `;
                    });
                    embedHtml += '</div>';
                }

                // Case 2: A quoted post
                if (embed.$type === 'app.bsky.embed.record' && embed.record) {
                    const quote = embed.record;
                    const quoteAuthor = quote.author;
                    const quoteContent = quote.value;
                    let quoteText = linkifyText(quoteContent.text.replace(/\n/g, '<br>'));

                    embedHtml += `
                        <div class="mt-4 border border-slate-700 rounded-lg p-3">
                            <div class="flex items-center space-x-2">
                                <img src="${quoteAuthor.avatar}" alt="${quoteAuthor.displayName}'s avatar" class="w-5 h-5 rounded-full">
                                <span class="font-semibold text-sm text-slate-300">${quoteAuthor.displayName}</span>
                                <span class="text-xs text-slate-500 truncate">@${quoteAuthor.handle}</span>
                            </div>
                            <p class="mt-2 text-sm text-slate-400">${quoteText}</p>
                        </div>
                    `;
                }
                
                // Case 3: Both media (images) and a quoted post
                if (embed.$type === 'app.bsky.embed.record_with_media' && embed.media && embed.record) {
                     // First, render the media (images)
                    if (embed.media.$type === 'app.bsky.embed.images') {
                        embedHtml += renderEmbed(embed.media);
                    }
                     // Then, render the record (quote)
                    if (embed.record.$type === 'app.bsky.embed.record') {
                         embedHtml += renderEmbed(embed.record);
                    }
                }


                return embedHtml;
            }
            
            async function fetchPosts() {
                try {
                    const response = await fetch(apiUrl);

                    if (!response.ok) {
                        throw new Error(`API responded with status: ${response.status}`);
                    }

                    const data = await response.json();
                    
                    // Hide loading indicator
                    loadingIndicator.style.display = 'none';

                    if (!data.posts || data.posts.length === 0) {
                        postsContainer.innerHTML = '<p class="text-center text-slate-400">No posts found.</p>';
                        return;
                    }
                    
                    // Clear container before adding new posts
                    postsContainer.innerHTML = ''; 

                    data.posts.forEach(post => {
                        const postAuthor = post.author;
                        const postRecord = post.record;
                        const postEmbed = post.embed;

                        // Create the main card element
                        const card = document.createElement('div');
                        card.className = 'bg-slate-800 border border-slate-700 rounded-lg p-4 sm:p-5 shadow-lg transition-transform duration-200 hover:scale-[1.02] hover:border-sky-600';

                        // Process text content
                        let postText = postRecord.text || '';
                        // Replace newline characters with <br> tags
                        postText = postText.replace(/\n/g, '<br>');
                        // Linkify URLs in the text
                        postText = linkifyText(postText);
                        
                        // Generate HTML for any embeds
                        const embedHtml = renderEmbed(postEmbed);

                        // Populate the card's inner HTML
                        card.innerHTML = `
                            <div class="flex items-start space-x-4">
                                <img src="${postAuthor.avatar || 'https://placehold.co/48x48/1e293b/94a3b8?text=??'}" alt="${postAuthor.displayName}'s avatar" class="w-12 h-12 rounded-full border-2 border-slate-600">
                                <div class="flex-1">
                                    <div class="flex items-baseline space-x-2">
                                        <span class="font-bold text-slate-100">${postAuthor.displayName}</span>
                                        <span class="text-sm text-slate-400 truncate">@${postAuthor.handle}</span>
                                    </div>
                                    <p class="text-xs text-slate-500">${formatDate(postRecord.createdAt)}</p>
                                </div>
                            </div>
                            <div class="mt-4 text-slate-300 leading-relaxed">${postText}</div>
                            ${embedHtml}
                        `;
                        
                        postsContainer.appendChild(card);
                    });

                } catch (error) {
                    console.error('Failed to fetch Bluesky posts:', error);
                    loadingIndicator.style.display = 'none';
                    errorMessageContainer.classList.remove('hidden');
                    errorMessageContainer.innerHTML = `
                        <p class="font-bold">Oops! Something went wrong.</p>
                        <p class="text-sm mt-1">Could not fetch posts from the Bluesky API. This might be a network issue or a temporary problem with the API. Please try again later.</p>
                        <p class="text-xs mt-2 font-mono bg-red-800/50 inline-block px-2 py-1 rounded">${error.message}</p>
                    `;
                }
            }

            fetchPosts();
        });
    </script>
</body>
</html>

