<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Office Online Viewer – Upload → Full‑Screen</title>
<style>
  html,body{margin:0;height:100%;font-family:sans-serif;background:#fafafa;color:#333;}
  #container{padding:1rem;}
  #msg{margin:1rem 0;color:#555;}
  #uploadForm{display:flex;gap:.5rem;align-items:center;margin:1rem 0;}
  #uploadForm input[type=file]{flex:1;}
  button{background:#0066cc;color:#fff;border:none;padding:.5rem 1rem;cursor:pointer;}
  button:hover{background:#0055aa;}
  /* Full‑screen iframe */
  #viewer{border:none;width:100%;height:100vh;display:none;}
</style>
</head>
<body>

<div id="container">
  <div id="msg">Loading…</div>

  <!-- Upload UI – only visible when no ?file= -->
  <form id="uploadForm" style="display:none;">
    <input type="file" id="fileInput" accept=".docx,.xlsx,.pptx" required />
    <button type="submit">Upload &amp; View</button>
  </form>

  <!-- Office‑Online iframe (full‑screen) -->
  <iframe id="viewer"></iframe>
</div>

<script>
(() => {
  const allowedExt = new Set(['docx','xlsx','pptx']);
  const msgEl   = document.getElementById('msg');
  const iframe  = document.getElementById('viewer');
  const uploadForm = document.getElementById('uploadForm');
  const fileInput  = document.getElementById('fileInput');

  const showMessage = (txt, hideIframe = true) => {
    msgEl.textContent = txt;
    msgEl.style.display = 'block';
    if (hideIframe) iframe.style.display = 'none';
  };

  const isValidExt = (urlObj) => {
    const ext = urlObj.pathname.split('.').pop().toLowerCase();
    return allowedExt.has(ext);
  };

  // -----------------------------------------------------------------
  // 1️⃣ Look for ?file= in the current URL
  // -----------------------------------------------------------------
  const params = new URLSearchParams(window.location.search);
  const fileParam = params.get('file');

  if (fileParam) {
    // ----- We have a URL – validate and embed ----------
    let target;
    try { target = new URL(fileParam); }
    catch (_) { return showMessage('❌ Invalid URL supplied in "?file=".'); }

    if (!isValidExt(target)) {
      return showMessage('❌ Unsupported file type. Allowed: .docx, .xlsx, .pptx');
    }

    const officeBase = 'https://view.officeapps.live.com/op/embed.aspx?src=';
    const embedUrl = officeBase + encodeURIComponent(target.href);

    iframe.src = embedUrl;
    iframe.onload = () => { msgEl.style.display = 'none'; iframe.style.display = 'block'; };
    iframe.onerror = () => showMessage('❌ Failed to load the Office viewer.');
    return;
  }

  // -----------------------------------------------------------------
  // 2️⃣ No ?file= – show the upload UI
  // -----------------------------------------------------------------
  showMessage('No file URL supplied. Upload a document below.', false);
  uploadForm.style.display = 'flex';

  // -----------------------------------------------------------------
  // 3️⃣ Upload handling
  // -----------------------------------------------------------------
  uploadForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const file = fileInput.files[0];
    if (!file) return showMessage('Please select a file first.');

    const ext = file.name.split('.').pop().toLowerCase();
    if (!allowedExt.has(ext)) {
      return showMessage(`Unsupported file type ".${ext}". Allowed: .docx, .xlsx, .pptx`);
    }

    showMessage('Uploading…');

    const formData = new FormData();
    formData.append('file', file);               // <-- field name expected by the CDN

    try {
      const resp = await fetch('https://cdn-upload.madebydanny.uk/upload', {
        method: 'POST',
        body: formData
      });

      if (!resp.ok) throw new Error(`Server responded ${resp.status}`);

      const data = await resp.json();           // expecting { "url": "https://…" }
      if (!data.url) throw new Error('Missing "url" in response');

      // Validate the returned URL before we redirect
      let uploadedUrl;
      try { uploadedUrl = new URL(data.url); }
      catch (_) { throw new Error('Returned URL is malformed'); }

      if (!isValidExt(uploadedUrl)) {
        throw new Error('Uploaded file has an unsupported extension');
      }

      // ------- REDIRECT to the same page with ?file= -------
      const newSearch = new URLSearchParams({ file: uploadedUrl.href }).toString();
      window.location.search = newSearch;   // triggers a full reload → full‑screen view
    } catch (err) {
      console.error(err);
      showMessage(`❌ Upload failed: ${err.message}`);
    }
  });
})();
</script>

</body>
</html>